C51 COMPILER V9.59.0.0   BLUETOOTH                                                         04/12/2019 14:01:02 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE BLUETOOTH
OBJECT MODULE PLACED IN ..\Objects\Bluetooth.obj
COMPILER INVOKED BY: F:\KEIL\C51\BIN\C51.EXE ..\HARDWARE\Bluetooth\Bluetooth.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\CORE;.
                    -.\USER;..\HARDWARE\LED;..\HARDWARE\TIMER;..\HARDWARE\USART;..\HARDWARE\demo;..\HARDWARE\Bluetooth) DEBUG OBJECTEXTEND PR
                    -INT(..\Listings\Bluetooth.lst) OBJECT(..\Objects\Bluetooth.obj)

line level    source

   1          /**
   2            ************************************* Copyright ****************************** 
   3            *
   4            *                 (C) Copyright 2019,ZERO,China, NANJING.
   5            *                            All Rights Reserved
   6            *                              
   7            *                     
   8            *                     https://user1513.github.io/Codes/
   9            *    
  10            * FileName   : Bluetooth.c   
  11            * Version    : v1.0           
  12            * Author     : ZERO                   
  13            * Date       : 2019-04-12         
  14            * Description:    
  15            * Function List:  
  16                  1. ....
  17                     <version>:           
  18            <modify staff>:
  19                            <data>:
  20             <description>:  
  21                  2. ...
  22            ******************************************************************************
  23           */
  24          #include "Bluetooth.h"
  25          #include "string.h"
  26          #include "stdio.h"
  27          #include "usart.h"
  28          #define COMMA_COUNT 2                                                                                                                                                                   //ÈÄóÂè∑ÁöÑ‰∏™Êï∞
  29          
  30          #define DATAPACK_LENGTH (COMMA_COUNT + 1)
  31          
  32          uint8_t xdata StrPack[DATAPACK_LENGTH][30] = {{0},{0},{0}};
  33           
  34          
  35          static uint8_t HandlerFunc(void) ;
  36          static uint8_t SubpackageAnalysis_Check(uint8_t * str);//ÂàÜÂåÖËß£Êûê
  37           
  38          static uint8_t SubpackageAnalysis_Check(uint8_t * str)//ÂàÜÂåÖËß£Êûê
  39          {
  40   1              uint8_t _CheckIsOk = 0;                                                                                                                                                                 //ËÆæÁΩÆËøîÂõûÂÄºÔºåÈªòËÆ§Ê£ÄÈ™åÂ§±Ë¥•
  41   1              uint8_t _CommaNum = 0;                                                                                                                                                                  //Ëé∑Âèñ','ÁöÑ‰∏™Êï∞
  42   1              uint8_t * _pStrCurrentAdder = str, * _pStrPreviousAdder = NULL;                                                                                 //ÂàõÂª∫ÂΩìÂâçÊåáÈíàÂèòÈáè‰∏éÂÖ
             -àÂâçÊåáÈíàÂèòÈáè
  43   1              if((strstr((char*) str,(char*)"AT") != NULL) && (strlen(str) == 2))
  44   1              {
  45   2                      _CheckIsOk = 2;
  46   2                      return _CheckIsOk;      
  47   2              }
  48   1              while(1)
  49   1              {
  50   2                      _pStrCurrentAdder = (uint8_t *)strchr((const char *)_pStrCurrentAdder, ',');                            //Ëé∑ÂèñÁ¨¨‰∏Ä‰∏™','ÊâÄÂ
             -ú®_pStrCurrentAdder‰∏≠ÁöÑÂú∞ÂùÄ,Ê≤°ÊúâÊâæÂà∞ÊòæÁ§∫NULL
  51   2                      if(_pStrCurrentAdder != _pStrPreviousAdder && _pStrCurrentAdder != NULL)                                        //Âà§Êñ≠ÂΩìÂâç‰∏é‰πãÂâç‰∏çÂ
C51 COMPILER V9.59.0.0   BLUETOOTH                                                         04/12/2019 14:01:02 PAGE 2   

             -êå
  52   2                      {
  53   3                              _CommaNum ++;                                                                                                                                                   //','‰∏™Êï∞++
  54   3                              _pStrPreviousAdder = _pStrCurrentAdder;                                                                                                 //Â∞ÜÂΩìÂâçÊåáÈíàÂèòÈáèÂÜÖÂÆπËµãÂÄºÁªô‰πãÂâçÁöÑÊåáÈ
             -íàÂèòÈáè
  55   3                              _pStrCurrentAdder++;                                                                                                                                    //ÂΩìÂâçÊåáÈíàÂèòÈáèÂú∞ÂùÄ++
  56   3                      }
  57   2                      else if(_CommaNum < COMMA_COUNT)                                                                                                                        //ÂΩì‰πãÂâçÊåáÈíàÂèòÈáèÁöÑÂú∞ÂùÄÁ≠â‰∫éÂΩìÂâçÊåáÈíàÂèòÈáèÂ
             -ú∞ÂùÄ && ','ÁöÑ‰∏™Êï∞Â∞è‰∫éÊ†°È™å‰∏™Êï∞ÈÄÄÂá∫Âæ™ÁéØ
  58   2                      {
  59   3                              break;
  60   3                      }
  61   2                      
  62   2                      if(_CommaNum == COMMA_COUNT && _pStrCurrentAdder == NULL)                                                                       //Âà§Êñ≠ÂΩìÈÄóÂè∑‰∏™Êï∞ÊòØÂê¶Á≠â‰∫éÂÆè
             -ÂÆö‰πâËÆæÂÆöÂÄº && ÂΩìÂâçÊåáÈíàÂèòÈáèÂÜÖÂÆπ‰∏∫NULL
  63   2                      {
  64   3                              _CheckIsOk = 1;                                                                                                                                             //ËÆæÁΩÆÊ£ÄÈ™åÊàêÂäü
  65   3                              break;
  66   3                      }
  67   2                      else if(_CommaNum > COMMA_COUNT)                                                                                                                        //Â¶ÇÊûúÈÄóÂè∑‰∏™Êï∞>ËÆæÂÆöÂÄºÈÄÄÂá∫
  68   2                      {
  69   3                              break;
  70   3                      }
  71   2              }
  72   1                      if((_CheckIsOk != 0) && (NULL == (uint8_t *)strchr((const char *)str, ';')))                            //ÂΩì_CheckIsOk‰∏∫ÈùûÈõ∂
             -Êó∂ && Êü•ÊâæStrÊï∞ÁªÑ‰∏≠';' == NULL
  73   1                      {
  74   2                              _CheckIsOk = 0;                                                                                                                                                 //ËÆæÁΩÆÊ†°È™åÂ§±Ë¥•            
  75   2                      }
  76   1                      return _CheckIsOk;                                                                                                                                                      //ËøîÂõû_CheckIsOkÁöÑÁä∂ÊÄÅ
  77   1      }
  78          
  79          
  80          uint8_t Data_Parsing_Func(uint8_t * str)
  81          {
  82   1              uint8_t i = 0;
  83   1              uint8_t _StateVal = 0;
  84   1              uint8_t * _pStrAdder = str;
  85   1              _StateVal = SubpackageAnalysis_Check(str);
  86   1              if(_StateVal == 1)
  87   1              {
  88   2                      for(i = 0; i < COMMA_COUNT; i++)
  89   2                      {
  90   3                              _pStrAdder = (uint8_t *)strchr((const char *)str, ',');
  91   3                              strncpy((char *)StrPack[i], (const char *)str, _pStrAdder - str);
  92   3                              *(StrPack[i] + (_pStrAdder - str)) = '\0';
  93   3                              str = _pStrAdder + 1;
  94   3                      }
  95   2                      _pStrAdder = (uint8_t *)strchr((const char *)str, ';');
  96   2                      strncpy((char *)StrPack[DATAPACK_LENGTH - 1], (const char *)str, _pStrAdder - str);
  97   2                      *(StrPack[i] + (_pStrAdder - str)) = '\0';
  98   2                      HandlerFunc();
  99   2              }
 100   1              return _StateVal;
 101   1      }
 102          
 103          uint8_t strupr(uint8_t *s)
 104          {
 105   1              uint8_t err = 1;
 106   1              if(s == NULL)
 107   1              {
 108   2                      err = 0;
C51 COMPILER V9.59.0.0   BLUETOOTH                                                         04/12/2019 14:01:02 PAGE 3   

 109   2                      return err;
 110   2              }
 111   1              while(*s != '\0')
 112   1              {
 113   2                      if( 'a' <= *s && 'z' >= *s)
 114   2                      {
 115   3                              *s -= 'a' - 'A';
 116   3                      }
 117   2                      s ++;
 118   2              }
 119   1              return err;
 120   1      }
 121          
 122          
 123          extern uint8_t cmd_able[];
 124          
 125          static uint8_t HandlerFunc(void) 
 126          {
 127   1              uint8_t err = 1;
 128   1              cmd_able[3] = 1;
 129   1              if(strcmp(StrPack[0],"LED") == 0)
 130   1              {
 131   2                      cmd_able[0] = 1;
 132   2              }
 133   1              else if(strcmp(StrPack[0],"BUZZER") == 0)
 134   1              {
 135   2                      cmd_able[0] = 2;
 136   2              }
 137   1              else if(strcmp(StrPack[0],"RELAY") == 0)
 138   1              {
 139   2                      cmd_able[0] = 3;
 140   2              }
 141   1              else
 142   1              {
 143   2                      UART_2SendString("ERROR:001");
 144   2                      cmd_able[3] = 0;
 145   2                      err = 0; 
 146   2              }
 147   1              if(err != 0)
 148   1              {       
 149   2                      if(cmd_able[0] == 1)
 150   2                      {
 151   3                              cmd_able[1] = 0;
 152   3                              if(strcmp(StrPack[1],"LED1") == 0)
 153   3                              {
 154   4                                      cmd_able[1] = 1;
 155   4                              }
 156   3                              else if(strcmp(StrPack[1],"LED2") == 0)
 157   3                              {
 158   4                                      cmd_able[1] = 2;
 159   4                              }
 160   3                              else if(strcmp(StrPack[1],"LED3") == 0)
 161   3                              {
 162   4                                      cmd_able[1] = 3;
 163   4                              }
 164   3                              else if(strcmp(StrPack[1],"LED4") == 0)
 165   3                              {
 166   4                                      cmd_able[1] = 4;
 167   4                              }
 168   3                              else if(strcmp(StrPack[1],"LED5") == 0)
 169   3                              {
 170   4                                      cmd_able[1] = 5;
C51 COMPILER V9.59.0.0   BLUETOOTH                                                         04/12/2019 14:01:02 PAGE 4   

 171   4                              }
 172   3                              else if(strcmp(StrPack[1],"LED6") == 0)
 173   3                              {
 174   4                                      cmd_able[1] = 6;
 175   4                              }
 176   3                              else if(strcmp(StrPack[1],"LED7") == 0)
 177   3                              {
 178   4                                      cmd_able[1] = 7;
 179   4                              }
 180   3                              else if(strcmp(StrPack[1],"LED8") == 0)
 181   3                              {
 182   4                                      cmd_able[1] = 8;
 183   4                              }
 184   3                              else
 185   3                              {
 186   4                                      
 187   4                              }
 188   3                      }
 189   2                      else if(cmd_able[0] == 3)
 190   2                      {
 191   3                              if(strcmp(StrPack[1],"RELAY1") == 0)
 192   3                              {
 193   4                                      cmd_able[1] = 1;
 194   4                              }
 195   3                              else if(strcmp(StrPack[1],"RELAY2") == 0)
 196   3                              {
 197   4                                      cmd_able[1] = 2;
 198   4                              }
 199   3                              else if(strcmp(StrPack[1],"RELAY3") == 0)
 200   3                              {
 201   4                                      cmd_able[1] = 3;
 202   4                              }
 203   3                              else if(strcmp(StrPack[1],"RELAY4") == 0)
 204   3                              {
 205   4                                      cmd_able[1] = 4;
 206   4                              }
 207   3                      }
 208   2                      else
 209   2                      {
 210   3                              if(strcmp(StrPack[1],"BUZZER1") == 0)
 211   3                              {
 212   4                                      cmd_able[1] = 1;
 213   4                              }
 214   3                      }
 215   2                      if(strcmp(StrPack[1],"ALL") == 0)
 216   2                      {
 217   3                              cmd_able[1] = 0xff;
 218   3                      }
 219   2                      if(cmd_able[1] == 0)
 220   2                      {
 221   3                              UART_2SendString("ERROR:002\n");
 222   3                              err = 0; 
 223   3                              cmd_able[3] = 0;
 224   3                      }
 225   2              }
 226   1              if(err != 0)
 227   1              {
 228   2                      if(strcmp(StrPack[2],"ON") == 0)
 229   2                      {
 230   3                              cmd_able[2] = 1;
 231   3                      }
 232   2                      else if(strcmp(StrPack[2],"OFF") == 0)
C51 COMPILER V9.59.0.0   BLUETOOTH                                                         04/12/2019 14:01:02 PAGE 5   

 233   2                      {
 234   3                              cmd_able[2] = 2;
 235   3                      }
 236   2                      else
 237   2                      {
 238   3                              UART_2SendString("ERROR:003\n");
 239   3                              err = 0; 
 240   3                              cmd_able[3] = 0;
 241   3                      }
 242   2              }
 243   1              return err;
 244   1      }
 245          
 246          
 247          
 248          
 249           
 250           
 251           
 252           
 253           
 254           
 255           
 256           
 257           
 258           
 259           
 260           
 261           
 262           
 263           
 264           
 265           
 266           
 267           
 268           
 269           
 270           
 271           
 272           


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1126    ----
   CONSTANT SIZE    =    139    ----
   XDATA SIZE       =     90    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      23
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
